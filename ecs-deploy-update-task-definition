
#!/usr/bin/env bash
set -e
# SERVICE='backgroundcheck-processingservice'
# CLUSTER='integration'
# REGION='ap-southeast-2'
# IMAGE='047651431481.dkr.ecr.us-east-1.amazonaws.com/backgroundcheck-processingservice'
# TAG=88
# TIMEOUT=30

# Check requirements
function require {
    command -v $1 > /dev/null 2>&1 || {
        echo "Some of the required software is not installed:"
        echo "    please install $1" >&2;
        exit 1;
    }
}

# Check for AWS, AWS Command Line Interface
require aws
# Check for jq, Command-line JSON processor
require jq

while [[ $# > 0 ]]
do
    key="$1"

    case $key in
        -r|--region)
            REGION="$2"
            shift # past argument
            ;;
        -c|--cluster)
            CLUSTER="$2"
            shift # past argument
            ;;
        -n|--service-name)
            SERVICE="$2"
            shift # past argument
            ;;
        -i|--image)
            IMAGE="$2"
            shift
            ;;
        -b|--build)
            TAG="$2"
            shift
            ;;
        -t|--timeout)
            TIMEOUT="$2"
            ;;
        *)
        ;;
    esac
    shift # past argument or value
done

echo "region is $REGION"
echo "cluster is $CLUSTER"
echo "service is $SERVICE"
echo "image is $IMAGE"
echo "Buildnumber is $TAG"
echo "Timeout is $TIMEOUT"

echo "Using image name: $IMAGE:$TAG"

AWS_ECS_COMMAND="aws --output json ecs --region $REGION" #intended space at the end.
TASK_DEF_URN=`$AWS_ECS_COMMAND describe-services --services $SERVICE --cluster $CLUSTER | jq -r .services[0].taskDefinition`
echo "Current task definition $TASK_DEF_URN"

CURRENT_TASK_DEF=`$AWS_ECS_COMMAND describe-task-definition --task-def $TASK_DEF_URN \
                  | sed -e "s|\"image\": *\"https:\/\/${IMAGE}:.*\"|\"image\": \"$IMAGE:$TAG\"|g" \
                  | jq '.taskDefinition|{family: .family, volumes: .volumes, containerDefinitions: .containerDefinitions}'`
#echo $CURRENT_TASK_DEF

NEW_TASKDEF=`$AWS_ECS_COMMAND register-task-definition --cli-input-json "$CURRENT_TASK_DEF" | jq -r .taskDefinition.taskDefinitionArn`
echo "New task definition: $NEW_TASKDEF";

UPDATE=`$AWS_ECS_COMMAND update-service --cluster $CLUSTER --service $SERVICE --task-definition $NEW_TASKDEF`

exit $lastexitcode
#Â© 2016 GitHub, Inc. Terms Privacy Security Status Help
